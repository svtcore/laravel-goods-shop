
/* cookies */

function createCookie(name, value, days) {
    var expires;

    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toGMTString();
    } else {
        expires = "";
    }
    document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + expires + "; path=/";
}

function readCookie(name) {
    var nameEQ = encodeURIComponent(name) + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ')
            c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0)
            return decodeURIComponent(c.substring(nameEQ.length, c.length));
    }
    return null;
}

function eraseCookie(name) {
    createCookie(name, "", -1);
}

function addItemToCart(product_id, data, count){
    data.items.push({"id": product_id, "count": count})
        createCookie("user_cart", JSON.stringify(data), 360);
        if ($("#cart_count").is('empty')) {
            var cart_counter = 1;
            $("#cart_count").text(cart_counter);
            $("#cart_count_mob").text(cart_counter);
        }
        else{
            var cart_counter = $("#cart_count").html();
            cart_counter++;
            $("#cart_count").text(cart_counter);
            $("#cart_count_mob").text(cart_counter);
        }
}

function addFirstItemToCart(product_id, count){
    var data = {items: [{"id": product_id, "count": count}]};
        createCookie("user_cart", JSON.stringify(data), 360);
        if ($("#cart_count").is('empty')) {
            var cart_counter = 1;
            $("#cart_count").text(cart_counter);
            $("#cart_count_mob").text(cart_counter);
        }
        else{
            var cart_counter = $("#cart_count").html();
            cart_counter++;
            $("#cart_count").text(cart_counter);
            $("#cart_count_mob").text(cart_counter);
        }
}

function removeProduct(product_id){
    var cookie_cart = readCookie("user_cart");
    if (cookie_cart != null){
        var data = JSON.parse(cookie_cart);
        var cart_array = Object.entries(data);
        for (var i = 0; i< cart_array[0][1].length; i++) {
                if (cart_array[0][1][i]['id'] == product_id){
                    cart_array[0][1].splice(i, 1); 
                    eraseCookie("user_cart");
                    data = Object.fromEntries(cart_array);
                    createCookie("user_cart", JSON.stringify(data), 360);
                    if ($("#cart_count").is('empty')) {
                        var cart_counter = "";
                        $("#cart_count").text(cart_counter);
                        $("#cart_count_mob").text(cart_counter);
                    }
                    else{
                        var cart_counter = $("#cart_count").html();
                        cart_counter--;
                        $("#cart_count").text(cart_counter);
                        $("#cart_count_mob").text(cart_counter);
                        if(cart_counter == 0){
                          location.reload();
                        }
                    }
                }
        }
    }
}


function changeProduct(product_id, new_count){
    var cookie_cart = readCookie("user_cart");
    if (cookie_cart != null){
        var data = JSON.parse(cookie_cart);
        var cart_array = Object.entries(data);
        for (var i = 0; i< cart_array[0][1].length; i++) {
                if (cart_array[0][1][i]['id'] == product_id){
                    cart_array[0][1][i]['count'] =  new_count;
                    eraseCookie("user_cart");
                    data = Object.fromEntries(cart_array);
                    createCookie("user_cart", JSON.stringify(data), 360);
                    break;
                }
        }
    }
}

function addToCart(product_id, count){
    var cookie_cart = readCookie("user_cart");
    if (cookie_cart != null){
        var data = JSON.parse(cookie_cart);
        var cart_array = Object.entries(data);
        for (var i = 0; i< cart_array[0][1].length; i++) {
                if (cart_array[0][1][i]['id'] == product_id){
                    cart_array[0][1][i]['count'] = count;
                    eraseCookie("user_cart");
                    data = Object.fromEntries(cart_array);
                    createCookie("user_cart", JSON.stringify(data), 360);
                    return 0;
                }
            }
            addItemToCart(product_id, data, count);
    }
    else{
        addFirstItemToCart(product_id, count);
    }
}


$(document).ready(function() {
    $('.selectpicker').selectpicker();
    var cookie_cart = readCookie("user_cart");
    if (cookie_cart != null){
        var data = JSON.parse(cookie_cart);
        var count = Object.entries(data["items"]).length;
        $("#cart_count").text(count);
        $("#cart_count_mob").text(count);
    }
 });



/*temp*/

$(document).ready(function () {

	/*	Disables mobile keyboard from displaying when clicking +/- inputs */

	$('.input-number-decrement').attr('readonly', 'readonly');
	$('.input-number-increment').attr('readonly', 'readonly');

	/*Attributes variables with min and max values for counter*/

	var min = $(".input-number-decrement").data("min");
	var max = $(".input-number-increment").data("max");

	/*Incrementally increases the value of the counter up to max value, and ensures +/- input works when input has no value (i.e. when the input-number field has been cleared) */

	$(".input-number-increment").on('click', function () {
		var $incdec = $(this).prev();

		if ($incdec.val() == '') {
			$incdec.val(1);
		} else if ($incdec.val() < max) {
            var new_val = $incdec.val(parseInt($incdec.val()) + 1);
            var id = $(this).attr("data-id");
            var new_price = parseInt($("#product_price_"+id).val()) * new_val.val();
            changeProduct(id, parseInt(new_val.val()));
            calculateTotal(new_price, $("#product_total_price_"+id).text());
            $("#product_total_price_"+id).html(new_price);
            document.getElementById('product_'+id).setAttribute('onclick',"addToCart("+id+","+new_val.val()+");")
        }
  });

  $("#show-delivery-form").on('click', function () {
    $("#collapseTwo").collapse({toggle: true}).collapse('show');
    $("#collapseTwo").get(0).scrollIntoView();
  });

	/*Incrementally decreases the value of the counter down to min value, and ensures +/- input works when input has no value (i.e. when the input-number field has been cleared) */

	$(".input-number-decrement").on('click', function () {
    var $incdec = $(this).next();
    if (parseInt($incdec.val()) - 1 == 0){
      var id = $(this).attr("data-id");
      removeProduct(id);
      var cart_product = $('#cart_product_'+id);
      calculateTotal(0, $("#product_total_price_"+id).text());
      cart_product.remove();
      return 0;
    }
		if ($incdec.val() == '') {
			$incdec.val(0);
		} else if ($incdec.val() > min) {
            var new_val = $incdec.val(parseInt($incdec.val()) - 1);
            var id = $(this).attr("data-id");
            var new_price = parseInt($("#product_price_"+id).val()) * new_val.val();
            changeProduct(id, parseInt(new_val.val()));
            calculateTotal(new_price, $("#product_total_price_"+id).text());
            $("#product_total_price_"+id).html(new_price);
            document.getElementById('product_'+id).setAttribute('onclick',"addToCart("+id+","+new_val.val()+");")
        }
  });
  
  function calculateTotal(new_price, old_price){
    $("#total-order-price").html((parseInt($("#total-order-price").html()) - parseInt(old_price) + parseInt(new_price)));
  }

	/* Removes any character other than a number that is entered in number input */

	var input = document.getElementsByClassName('input-number');

	$(input).on('keyup input', function () {

		this.value = this.value.replace(/[^0-9]/g, '');

		/* Gives an error if number entered is over max */

		if (this.value > max) {
			this.value = max;
			error();
		}
	});

	/* Function to display error for numbers over max */

	function error() {
		$('.data').empty();
		$('.data').append('<p class="error">You can only order between ' + min + ' and ' + max + ' items!</p>');
		$(".data").fadeIn(400);

		/* Fades out error once the counter is clicked on */

		$(".counter").on('click', function () {
			$(".error").fadeOut(800);
		});
	}

});




    $(document).ready(function () {
      //Initialize tooltips
      $('.nav-tabs > li a[title]').tooltip();
      
      //Wizard
      $('a[data-toggle="tab"]').on('show.bs.tab', function (e) {
  
          var $target = $(e.target);
      
          if ($target.parent().hasClass('disabled')) {
              return false;
          }
      });
  
      $(".next-step").click(function (e) {
  
          var $active = $('.wizard .nav-tabs li.active');
          $active.next().removeClass('disabled');
          nextTab($active);
  
      });
      $(".prev-step").click(function (e) {
  
          var $active = $('.wizard .nav-tabs li.active');
          prevTab($active);
  
      });
  });
  
  $('.panel-collapse').on('show.bs.collapse', function () {
    $(this).siblings('.panel-heading').addClass('active');
  });

  $('.panel-collapse').on('hide.bs.collapse', function () {
    $(this).siblings('.panel-heading').removeClass('active');
  });

  $('#input_search').bind("change keyup input click", function() {
    if (this.value.length == 0) {
        $(".search_result").fadeOut();
        $('.search_result_link').text("");
    }
    else {
        if (($(".search_result_link").prop("style")["display"] !== 'none') && this.value.length > 3 && ($('.search_result_link').text()).length > 0)
            $(".search_result").fadeIn();
    }
});

